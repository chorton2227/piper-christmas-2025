<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Quest - Exercise 2 Complete (All 5 Features)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h1 { text-align: center; color: #764ba2; margin-bottom: 20px; }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }
        
        .difficulty-selector {
            display: flex;
            gap: 10px;
        }
        
        .difficulty-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .difficulty-btn.easy { background: #28a745; color: white; }
        .difficulty-btn.normal { background: #ffc107; color: #000; }
        .difficulty-btn.hard { background: #dc3545; color: white; }
        .difficulty-btn.active { transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .location-panel {
            background: linear-gradient(to right, #fff, #f8f9fa);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .location-panel h2 { color: #764ba2; margin-bottom: 10px; }
        
        .message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 600;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.info { background: #d1ecf1; color: #0c5460; }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        
        .panel h3 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .quest-item, .achievement-item, .equipment-slot {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        
        .quest-item.completed { opacity: 0.6; border-left-color: #28a745; }
        .achievement-item.locked { opacity: 0.4; }
        .achievement-item.unlocked { border-left-color: #ffc107; }
        
        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s;
        }
        
        .combat-panel {
            background: linear-gradient(135deg, #dc3545, #c82333);
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-top: 20px;
        }
        
        .combat-panel h3 { margin-bottom: 15px; }
        
        .enemy-health-bar {
            background: rgba(255,255,255,0.3);
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .enemy-health-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .combat-log {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .combat-message {
            padding: 5px;
            margin: 3px 0;
            border-radius: 3px;
        }
        
        .combat-message.player { background: rgba(40, 167, 69, 0.3); }
        .combat-message.enemy { background: rgba(220, 53, 69, 0.3); }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .inventory-item {
            background: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .inventory-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .controls button { flex: 1; min-width: 120px; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #dc3545;
        }
        
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .achievement-notification {
            position: fixed;
            top: -200px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10000;
            transition: top 0.5s;
            text-align: center;
        }
        
        .achievement-notification.show { top: 20px; }
        
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .stats { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>⚔️ Adventure Quest - Extended Edition ⚔️</h1>
        
        <!-- Top Bar with Stats and Difficulty -->
        <div class="top-bar">
            <div class="stats">
                <div class="stat">
                    ❤️ <span class="stat-value" id="health">100/100</span>
                </div>
                <div class="stat">
                    💰 <span class="stat-value" id="gold">50</span>
                </div>
                <div class="stat">
                    ⚔️ <span class="stat-value" id="attack">10</span>
                </div>
                <div class="stat">
                    🛡️ <span class="stat-value" id="defense">5</span>
                </div>
                <div class="stat">
                    ⭐ Lv.<span class="stat-value" id="level">1</span>
                </div>
            </div>
            <div class="difficulty-selector">
                <button class="difficulty-btn easy" onclick="game.setDifficulty('easy')">Easy</button>
                <button class="difficulty-btn normal active" onclick="game.setDifficulty('normal')">Normal</button>
                <button class="difficulty-btn hard" onclick="game.setDifficulty('hard')">Hard</button>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Left: Location and Actions -->
            <div>
                <div class="location-panel">
                    <h2 id="location-name">Town Square</h2>
                    <p id="location-desc">You are in the bustling town square.</p>
                    <div id="messages"></div>
                </div>
                
                <div class="actions" id="action-buttons"></div>
                
                <div class="combat-panel" id="combat-panel" style="display: none;">
                    <h3 id="enemy-name">Enemy</h3>
                    <div class="enemy-health-bar">
                        <div class="enemy-health-fill" id="enemy-health-bar">100/100</div>
                    </div>
                    <div class="actions">
                        <button onclick="game.attack()">⚔️ Attack</button>
                        <button onclick="game.defend()">🛡️ Defend</button>
                        <button onclick="game.usePotion()">🧪 Potion</button>
                        <button onclick="game.flee()">🏃 Flee</button>
                    </div>
                    <div class="combat-log" id="combat-log"></div>
                </div>
            </div>
            
            <!-- Right: Sidebar Panels -->
            <div class="sidebar">
                <!-- Equipment -->
                <div class="panel">
                    <h3>⚔️ Equipment</h3>
                    <div id="equipment"></div>
                </div>
                
                <!-- Inventory -->
                <div class="panel">
                    <h3>🎒 Inventory (<span id="inv-count">0</span>)</h3>
                    <div class="inventory-grid" id="inventory"></div>
                </div>
                
                <!-- Quests -->
                <div class="panel">
                    <h3>📜 Quests</h3>
                    <div id="quests"></div>
                </div>
                
                <!-- Achievements -->
                <div class="panel">
                    <h3>🏆 Achievements (<span id="ach-count">0/5</span>)</h3>
                    <div id="achievements"></div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <button onclick="game.saveGame()">💾 Save</button>
            <button onclick="game.loadGame()">📂 Load</button>
            <button onclick="game.resetGame()">🔄 Reset</button>
        </div>
    </div>
    
    <!-- Shop Modal -->
    <div class="modal" id="shop-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="game.closeShop()">&times;</span>
            <h2>🏪 Item Shop</h2>
            <div id="shop-items"></div>
        </div>
    </div>
    
    <script>
        // ========================================
        // GAME DATA
        // ========================================
        
        const ITEMS = {
            healthPotion: {
                id: 'healthPotion',
                name: 'Health Potion',
                type: 'consumable',
                healing: 30,
                price: 20,
                description: '+30 HP'
            },
            sword: {
                id: 'sword',
                name: 'Iron Sword',
                type: 'weapon',
                slot: 'weapon',
                attackBonus: 5,
                price: 50,
                description: '+5 Attack'
            },
            shield: {
                id: 'shield',
                name: 'Wooden Shield',
                type: 'armor',
                slot: 'armor',
                defenseBonus: 3,
                price: 40,
                description: '+3 Defense'
            },
            ring: {
                id: 'ring',
                name: 'Power Ring',
                type: 'accessory',
                slot: 'accessory',
                attackBonus: 2,
                defenseBonus: 2,
                price: 80,
                description: '+2 ATK/DEF'
            }
        };
        
        const MONSTERS = {
            goblin: { id: 'goblin', name: 'Goblin', health: 30, maxHealth: 30, attack: 5, defense: 2, gold: 15, xp: 10 },
            wolf: { id: 'wolf', name: 'Wolf', health: 40, maxHealth: 40, attack: 7, defense: 3, gold: 20, xp: 15 },
            bandit: { id: 'bandit', name: 'Bandit', health: 50, maxHealth: 50, attack: 8, defense: 4, gold: 30, xp: 20 },
            orc: { id: 'orc', name: 'Orc', health: 70, maxHealth: 70, attack: 10, defense: 5, gold: 50, xp: 30 }
        };
        
        const LOCATIONS = {
            town: {
                id: 'town',
                name: 'Town Square',
                description: 'A bustling town square with merchants and travelers.',
                actions: [
                    { text: '🏪 Shop', action: 'openShop' },
                    { text: '🍺 Tavern', action: 'visitTavern' },
                    { text: '🌲 Forest', action: 'goForest' },
                    { text: '🏔️ Cave', action: 'goCave' }
                ]
            },
            forest: {
                id: 'forest',
                name: 'Dark Forest',
                description: 'Tall trees block out the sun. Strange sounds echo.',
                encounters: ['goblin', 'wolf', 'bandit'],
                actions: [
                    { text: '⚔️ Hunt', action: 'hunt' },
                    { text: '🔍 Explore', action: 'explore' },
                    { text: '🏘️ Town', action: 'goTown' }
                ]
            },
            cave: {
                id: 'cave',
                name: 'Mysterious Cave',
                description: 'A dark cave entrance. You hear echoes within.',
                encounters: ['wolf', 'bandit', 'orc'],
                actions: [
                    { text: '⚔️ Hunt', action: 'hunt' },
                    { text: '🔍 Explore', action: 'explore' },
                    { text: '🏘️ Town', action: 'goTown' }
                ]
            },
            tavern: {
                id: 'tavern',
                name: 'Cozy Tavern',
                description: 'A warm fireplace crackles. The innkeeper smiles.',
                actions: [
                    { text: '💤 Rest (20g)', action: 'rest' },
                    { text: '🏘️ Leave', action: 'goTown' }
                ]
            }
        };
        
        const DIFFICULTY = {
            easy: { damageMultiplier: 0.75, goldMultiplier: 1.25, xpMultiplier: 1.0 },
            normal: { damageMultiplier: 1.0, goldMultiplier: 1.0, xpMultiplier: 1.0 },
            hard: { damageMultiplier: 1.5, goldMultiplier: 1.5, xpMultiplier: 2.0 }
        };
        
        const RANDOM_EVENTS = [
            { name: 'Merchant', description: 'A merchant gives you a potion!', effect: (g) => g.player.inventory.push('healthPotion') },
            { name: 'Treasure', description: 'You found a treasure chest!', effect: (g) => { g.player.gold += 50; g.showMessage('Found 50 gold!', 'success'); } },
            { name: 'Blessing', description: 'A mysterious aura surrounds you!', effect: (g) => { g.player.attack += 2; g.showMessage('+2 Attack!', 'success'); } },
            { name: 'Trap', description: 'You triggered a trap!', effect: (g) => { g.player.health = Math.max(1, g.player.health - 10); g.showMessage('-10 HP!', 'error'); } }
        ];
        
        // ========================================
        // GAME OBJECT
        // ========================================
        
        const game = {
            player: {
                health: 100,
                maxHealth: 100,
                attack: 10,
                defense: 5,
                gold: 50,
                xp: 0,
                level: 1,
                inventory: ['healthPotion', 'healthPotion'],
                equipment: { weapon: null, armor: null, accessory: null }
            },
            
            currentLocation: 'town',
            difficulty: 'normal',
            inCombat: false,
            currentEnemy: null,
            playerDefending: false,
            
            quests: {
                firstBlood: { name: 'First Blood', desc: 'Defeat 1 monster', type: 'kill', required: 1, current: 0, completed: false, reward: { gold: 50, xp: 25 } },
                hunter: { name: 'Monster Hunter', desc: 'Defeat 5 monsters', type: 'kill', required: 5, current: 0, completed: false, reward: { gold: 100, attack: 2 } },
                wealthy: { name: 'Wealthy', desc: 'Collect 200 gold', type: 'gold', required: 200, current: 0, completed: false, reward: { maxHealth: 20 } }
            },
            
            achievements: {
                firstVictory: { name: 'First Victory', desc: 'Win first battle', unlocked: false, check: (g) => g.stats.wins >= 1 },
                survivor: { name: 'Survivor', desc: 'Win with 1 HP', unlocked: false, check: (g) => g.player.health === 1 && g.justWon },
                wealthy: { name: 'Wealthy', desc: 'Have 500 gold', unlocked: false, check: (g) => g.player.gold >= 500 },
                warrior: { name: 'Warrior', desc: 'Defeat 10 monsters', unlocked: false, check: (g) => g.stats.monstersDefeated >= 10 },
                legendary: { name: 'Legendary', desc: 'Reach level 5', unlocked: false, check: (g) => g.player.level >= 5 }
            },
            
            stats: { wins: 0, monstersDefeated: 0, totalGoldEarned: 0 },
            justWon: false,
            
            init() {
                this.updateUI();
                if (localStorage.getItem('adventureGameEx2')) {
                    this.showMessage('Saved game found! Click Load to continue.', 'info');
                }
                this.setDifficulty('normal');
            },
            
            setDifficulty(level) {
                this.difficulty = level;
                document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.difficulty-btn.${level}`).classList.add('active');
                this.showMessage(`Difficulty: ${level.toUpperCase()}`, 'info');
            },
            
            updateUI() {
                document.getElementById('health').textContent = `${this.player.health}/${this.player.maxHealth}`;
                document.getElementById('gold').textContent = this.player.gold;
                document.getElementById('attack').textContent = this.player.attack;
                document.getElementById('defense').textContent = this.player.defense;
                document.getElementById('level').textContent = this.player.level;
                
                const loc = LOCATIONS[this.currentLocation];
                document.getElementById('location-name').textContent = loc.name;
                document.getElementById('location-desc').textContent = loc.description;
                
                this.updateActionButtons();
                this.updateInventory();
                this.updateEquipment();
                this.updateQuests();
                this.updateAchievements();
            },
            
            updateActionButtons() {
                const loc = LOCATIONS[this.currentLocation];
                const container = document.getElementById('action-buttons');
                container.innerHTML = '';
                
                loc.actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.textContent = action.text;
                    btn.onclick = () => this[action.action]();
                    container.appendChild(btn);
                });
            },
            
            updateInventory() {
                const container = document.getElementById('inventory');
                container.innerHTML = '';
                
                const counts = {};
                this.player.inventory.forEach(id => counts[id] = (counts[id] || 0) + 1);
                
                for (let id in counts) {
                    const item = ITEMS[id];
                    const div = document.createElement('div');
                    div.className = 'inventory-item';
                    div.onclick = () => this.useItem(id);
                    div.innerHTML = `<strong>${item.name}</strong><br>${counts[id] > 1 ? `×${counts[id]}` : ''}<br><small>${item.description}</small>`;
                    container.appendChild(div);
                }
                
                document.getElementById('inv-count').textContent = this.player.inventory.length;
            },
            
            updateEquipment() {
                const container = document.getElementById('equipment');
                container.innerHTML = '';
                
                for (let slot in this.player.equipment) {
                    const itemId = this.player.equipment[slot];
                    const div = document.createElement('div');
                    div.className = 'equipment-slot';
                    
                    if (itemId) {
                        const item = ITEMS[itemId];
                        div.innerHTML = `<strong>${slot}:</strong> ${item.name}<br><button onclick="game.unequipItem('${slot}')">Unequip</button>`;
                    } else {
                        div.innerHTML = `<strong>${slot}:</strong> Empty`;
                    }
                    
                    container.appendChild(div);
                }
            },
            
            updateQuests() {
                const container = document.getElementById('quests');
                container.innerHTML = '';
                
                for (let id in this.quests) {
                    const quest = this.quests[id];
                    const div = document.createElement('div');
                    div.className = `quest-item ${quest.completed ? 'completed' : ''}`;
                    
                    const progress = Math.min(100, (quest.current / quest.required) * 100);
                    
                    div.innerHTML = `
                        <strong>${quest.name}</strong> ${quest.completed ? '✓' : ''}
                        <p>${quest.desc}</p>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
                        <small>${quest.current}/${quest.required}</small>
                    `;
                    
                    container.appendChild(div);
                }
            },
            
            updateAchievements() {
                const container = document.getElementById('achievements');
                container.innerHTML = '';
                
                let unlocked = 0;
                let total = 0;
                
                for (let id in this.achievements) {
                    const ach = this.achievements[id];
                    total++;
                    if (ach.unlocked) unlocked++;
                    
                    const div = document.createElement('div');
                    div.className = `achievement-item ${ach.unlocked ? 'unlocked' : 'locked'}`;
                    div.innerHTML = `${ach.unlocked ? '🏆' : '🔒'} <strong>${ach.name}</strong><br><small>${ach.desc}</small>`;
                    container.appendChild(div);
                }
                
                document.getElementById('ach-count').textContent = `${unlocked}/${total}`;
            },
            
            goTown() { this.goToLocation('town'); },
            goForest() { this.goToLocation('forest'); },
            goCave() { this.goToLocation('cave'); },
            visitTavern() { this.goToLocation('tavern'); },
            
            goToLocation(id) {
                this.currentLocation = id;
                this.inCombat = false;
                document.getElementById('combat-panel').style.display = 'none';
                this.updateUI();
            },
            
            explore() {
                if (Math.random() < 0.2) {
                    const event = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
                    this.showMessage(`${event.name}: ${event.description}`, 'info');
                    event.effect(this);
                    this.updateUI();
                } else {
                    const gold = Math.floor(Math.random() * 20) + 10;
                    this.player.gold += gold;
                    this.showMessage(`Found ${gold} gold!`, 'success');
                    this.updateQuestProgress('gold', gold);
                    this.updateUI();
                }
            },
            
            hunt() {
                const loc = LOCATIONS[this.currentLocation];
                if (!loc.encounters) return;
                
                const monsterId = loc.encounters[Math.floor(Math.random() * loc.encounters.length)];
                this.startCombat(monsterId);
            },
            
            startCombat(monsterId) {
                this.currentEnemy = JSON.parse(JSON.stringify(MONSTERS[monsterId]));
                this.inCombat = true;
                this.playerDefending = false;
                this.justWon = false;
                
                document.getElementById('combat-panel').style.display = 'block';
                document.getElementById('enemy-name').textContent = this.currentEnemy.name;
                this.updateEnemyHealthBar();
                document.getElementById('combat-log').innerHTML = '';
                this.addCombatMessage(`A ${this.currentEnemy.name} appears!`, 'info');
            },
            
            attack() {
                if (!this.inCombat) return;
                
                const baseDamage = this.player.attack;
                const damage = Math.max(0, Math.floor(Math.random() * baseDamage + baseDamage / 2) - this.currentEnemy.defense);
                
                this.currentEnemy.health -= damage;
                this.addCombatMessage(`You attack for ${damage} damage!`, 'player');
                this.updateEnemyHealthBar();
                
                if (this.currentEnemy.health <= 0) {
                    this.victory();
                } else {
                    setTimeout(() => this.enemyAttack(), 1000);
                }
                
                this.playerDefending = false;
            },
            
            defend() {
                if (!this.inCombat) return;
                this.playerDefending = true;
                this.addCombatMessage('You brace for impact!', 'player');
                setTimeout(() => this.enemyAttack(), 1000);
            },
            
            usePotion() {
                if (!this.inCombat) return;
                
                const idx = this.player.inventory.indexOf('healthPotion');
                if (idx === -1) {
                    this.showMessage('No potions!', 'error');
                    return;
                }
                
                this.player.health = Math.min(this.player.health + 30, this.player.maxHealth);
                this.player.inventory.splice(idx, 1);
                this.addCombatMessage('Used Health Potion! +30 HP', 'player');
                this.updateUI();
                
                setTimeout(() => this.enemyAttack(), 1000);
            },
            
            flee() {
                if (!this.inCombat) return;
                
                if (Math.random() < 0.5) {
                    this.addCombatMessage('Fled successfully!', 'info');
                    setTimeout(() => {
                        this.inCombat = false;
                        document.getElementById('combat-panel').style.display = 'none';
                        this.showMessage('You escaped!', 'success');
                    }, 1000);
                } else {
                    this.addCombatMessage('Failed to escape!', 'info');
                    setTimeout(() => this.enemyAttack(), 1000);
                }
            },
            
            enemyAttack() {
                if (!this.inCombat) return;
                
                if (Math.random() < 0.1) {
                    this.addCombatMessage('Enemy missed!', 'enemy');
                    return;
                }
                
                const baseDamage = this.currentEnemy.attack;
                const diffMult = DIFFICULTY[this.difficulty].damageMultiplier;
                let damage = Math.floor((Math.random() * baseDamage + baseDamage / 2) * diffMult);
                
                const defense = this.playerDefending ? this.player.defense * 2 : this.player.defense;
                damage = Math.max(0, damage - defense);
                
                this.player.health -= damage;
                this.addCombatMessage(`${this.currentEnemy.name} attacks for ${damage} damage!`, 'enemy');
                
                if (this.playerDefending) {
                    this.addCombatMessage('Defense absorbed some damage!', 'info');
                }
                
                this.updateUI();
                
                if (this.player.health <= 0) {
                    this.defeat();
                }
                
                this.playerDefending = false;
            },
            
            victory() {
                this.inCombat = false;
                this.justWon = true;
                
                const diffMult = DIFFICULTY[this.difficulty];
                const gold = Math.floor(this.currentEnemy.gold * diffMult.goldMultiplier);
                const xp = Math.floor(this.currentEnemy.xp * diffMult.xpMultiplier);
                
                this.player.gold += gold;
                this.player.xp += xp;
                this.stats.wins++;
                this.stats.monstersDefeated++;
                this.stats.totalGoldEarned += gold;
                
                this.addCombatMessage(`Victory! +${gold}g, +${xp}XP`, 'info');
                
                this.updateQuestProgress('kill', 1);
                this.checkAchievements();
                this.checkLevelUp();
                
                setTimeout(() => {
                    document.getElementById('combat-panel').style.display = 'none';
                    this.showMessage('You won!', 'success');
                    this.updateUI();
                }, 2000);
            },
            
            defeat() {
                this.inCombat = false;
                this.justWon = false;
                
                const goldLost = Math.floor(this.player.gold * 0.2);
                this.player.gold -= goldLost;
                this.player.health = this.player.maxHealth;
                
                this.addCombatMessage('Defeated!', 'enemy');
                
                setTimeout(() => {
                    document.getElementById('combat-panel').style.display = 'none';
                    this.currentLocation = 'town';
                    this.showMessage(`Defeated! Lost ${goldLost}g. Back to town.`, 'error');
                    this.updateUI();
                }, 2000);
            },
            
            checkLevelUp() {
                const xpNeeded = this.player.level * 100;
                
                while (this.player.xp >= xpNeeded) {
                    this.player.xp -= xpNeeded;
                    this.player.level++;
                    this.player.maxHealth += 10;
                    this.player.health = this.player.maxHealth;
                    this.player.attack += 2;
                    this.player.defense += 1;
                    
                    this.showMessage(`Level Up! Now level ${this.player.level}!`, 'success');
                    this.checkAchievements();
                }
            },
            
            updateQuestProgress(type, amount) {
                for (let id in this.quests) {
                    const quest = this.quests[id];
                    if (quest.completed) continue;
                    
                    if (quest.type === type) {
                        quest.current += amount;
                        
                        if (quest.current >= quest.required) {
                            quest.completed = true;
                            
                            if (quest.reward.gold) this.player.gold += quest.reward.gold;
                            if (quest.reward.xp) this.player.xp += quest.reward.xp;
                            if (quest.reward.attack) this.player.attack += quest.reward.attack;
                            if (quest.reward.maxHealth) {
                                this.player.maxHealth += quest.reward.maxHealth;
                                this.player.health += quest.reward.maxHealth;
                            }
                            
                            this.showMessage(`Quest Complete: ${quest.name}!`, 'success');
                            this.checkLevelUp();
                            this.checkAchievements();
                        }
                    }
                }
                
                this.updateQuests();
            },
            
            checkAchievements() {
                for (let id in this.achievements) {
                    const ach = this.achievements[id];
                    
                    if (!ach.unlocked && ach.check(this)) {
                        ach.unlocked = true;
                        this.unlockAchievement(ach);
                    }
                }
                
                this.updateAchievements();
            },
            
            unlockAchievement(ach) {
                const notif = document.createElement('div');
                notif.className = 'achievement-notification';
                notif.innerHTML = `<h3>🏆 Achievement Unlocked!</h3><h4>${ach.name}</h4><p>${ach.desc}</p>`;
                document.body.appendChild(notif);
                
                setTimeout(() => notif.classList.add('show'), 100);
                setTimeout(() => {
                    notif.classList.remove('show');
                    setTimeout(() => notif.remove(), 500);
                }, 4000);
            },
            
            updateEnemyHealthBar() {
                const pct = (this.currentEnemy.health / this.currentEnemy.maxHealth) * 100;
                const bar = document.getElementById('enemy-health-bar');
                bar.style.width = pct + '%';
                bar.textContent = `${this.currentEnemy.health}/${this.currentEnemy.maxHealth}`;
            },
            
            addCombatMessage(text, type) {
                const log = document.getElementById('combat-log');
                const msg = document.createElement('div');
                msg.className = `combat-message ${type}`;
                msg.textContent = text;
                log.appendChild(msg);
                log.scrollTop = log.scrollHeight;
            },
            
            useItem(itemId) {
                const item = ITEMS[itemId];
                
                if (item.type === 'consumable') {
                    if (this.player.health === this.player.maxHealth) {
                        this.showMessage('Already at full health!', 'info');
                        return;
                    }
                    
                    this.player.health = Math.min(this.player.health + item.healing, this.player.maxHealth);
                    const idx = this.player.inventory.indexOf(itemId);
                    this.player.inventory.splice(idx, 1);
                    this.showMessage(`Used ${item.name}! +${item.healing} HP`, 'success');
                    this.updateUI();
                } else if (item.slot) {
                    this.equipItem(itemId);
                }
            },
            
            equipItem(itemId) {
                const item = ITEMS[itemId];
                const slot = item.slot;
                
                if (this.player.equipment[slot]) {
                    const oldItem = this.player.equipment[slot];
                    this.unequipItem(slot);
                }
                
                this.player.equipment[slot] = itemId;
                
                if (item.attackBonus) this.player.attack += item.attackBonus;
                if (item.defenseBonus) this.player.defense += item.defenseBonus;
                
                const idx = this.player.inventory.indexOf(itemId);
                this.player.inventory.splice(idx, 1);
                
                this.showMessage(`Equipped ${item.name}!`, 'success');
                this.updateUI();
            },
            
            unequipItem(slot) {
                const itemId = this.player.equipment[slot];
                if (!itemId) return;
                
                const item = ITEMS[itemId];
                
                if (item.attackBonus) this.player.attack -= item.attackBonus;
                if (item.defenseBonus) this.player.defense -= item.defenseBonus;
                
                this.player.inventory.push(itemId);
                this.player.equipment[slot] = null;
                
                this.showMessage(`Unequipped ${item.name}`, 'info');
                this.updateUI();
            },
            
            openShop() {
                const modal = document.getElementById('shop-modal');
                const container = document.getElementById('shop-items');
                container.innerHTML = '';
                
                for (let id in ITEMS) {
                    const item = ITEMS[id];
                    const div = document.createElement('div');
                    div.className = 'shop-item';
                    div.innerHTML = `
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.description}</small>
                        </div>
                        <div>
                            <span style="color: #ffc107; font-weight: bold;">${item.price}g</span>
                            <button onclick="game.buyItem('${id}')">Buy</button>
                        </div>
                    `;
                    container.appendChild(div);
                }
                
                modal.classList.add('active');
            },
            
            closeShop() {
                document.getElementById('shop-modal').classList.remove('active');
            },
            
            buyItem(itemId) {
                const item = ITEMS[itemId];
                
                if (this.player.gold >= item.price) {
                    this.player.gold -= item.price;
                    this.player.inventory.push(itemId);
                    this.showMessage(`Bought ${item.name}!`, 'success');
                    this.updateUI();
                } else {
                    this.showMessage('Not enough gold!', 'error');
                }
            },
            
            rest() {
                if (this.player.gold >= 20) {
                    this.player.gold -= 20;
                    this.player.health = this.player.maxHealth;
                    this.showMessage('Rested and restored health!', 'success');
                    this.updateUI();
                } else {
                    this.showMessage('Not enough gold!', 'error');
                }
            },
            
            showMessage(text, type) {
                const container = document.getElementById('messages');
                const msg = document.createElement('div');
                msg.className = `message ${type}`;
                msg.textContent = text;
                container.appendChild(msg);
                
                setTimeout(() => {
                    msg.style.opacity = '0';
                    setTimeout(() => msg.remove(), 300);
                }, 3000);
            },
            
            saveGame() {
                const data = {
                    player: this.player,
                    location: this.currentLocation,
                    difficulty: this.difficulty,
                    quests: this.quests,
                    achievements: this.achievements,
                    stats: this.stats
                };
                
                localStorage.setItem('adventureGameEx2', JSON.stringify(data));
                this.showMessage('Game saved!', 'success');
            },
            
            loadGame() {
                const saved = localStorage.getItem('adventureGameEx2');
                if (!saved) {
                    this.showMessage('No saved game!', 'error');
                    return;
                }
                
                const data = JSON.parse(saved);
                this.player = data.player;
                this.currentLocation = data.location;
                this.difficulty = data.difficulty || 'normal';
                this.quests = data.quests;
                this.achievements = data.achievements;
                this.stats = data.stats;
                this.inCombat = false;
                
                document.getElementById('combat-panel').style.display = 'none';
                this.setDifficulty(this.difficulty);
                this.updateUI();
                this.showMessage('Game loaded!', 'success');
            },
            
            resetGame() {
                if (confirm('Reset game? All progress will be lost!')) {
                    localStorage.removeItem('adventureGameEx2');
                    location.reload();
                }
            }
        };
        
        // Initialize game
        game.init();
    </script>
</body>